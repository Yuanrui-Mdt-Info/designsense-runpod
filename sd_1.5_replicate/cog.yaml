# Configuration for Cog ⚙️
# Reference: https://github.com/replicate/cog/blob/main/docs/yaml.md

build:
  gpu: true
  cuda: "12.4"
  python_version: "3.11"

  system_packages:
    - git
    - git-lfs
    - wget
    - curl
    - libgl1-mesa-glx
    - libglib2.0-0
    - libsm6
    - libxext6
    - libxrender-dev
  
  python_packages:
    # Core DL Framework (Stable versions)
    - "torch==2.7.1"
    - "torchvision==0.22.1"
    
    # Hugging Face Ecosystem
    - "diffusers==0.36.0"
    - "transformers==4.57.3"
    - "accelerate==1.12.0"
    - "peft==0.18.0"
    - "safetensors==0.6.2"
    
    # Image Processing
    - "opencv-python==4.11.0.86"
    - "numpy==1.26.4"
    - "pillow==11.3.0"

  run:
    # 1. 安装 pget (这是 Replicate 官方推荐的高速下载器)
    - curl -o /usr/local/bin/pget -L "https://github.com/replicate/pget/releases/download/v0.11.0/pget_linux_x86_64" && chmod +x /usr/local/bin/pget
    
    # 2. 创建模型目录
    - mkdir -p model_cache

    # 3. 下载模型 (注意：这里你需要找到模型的真实下载直链)
    # ⚠️ SD 1.5 / Realistic Vision 通常是文件夹结构，稍微有点麻烦。
    # 推荐：下载 safetensors 单文件版本（如果 pipeline 支持），或者打包好的 tar 文件。
    
    # 方案 A: 如果能找到 safetensors 单文件 (最简单)
    # - pget -f https://huggingface.co/SG161222/Realistic_Vision_V6.0_B1_noVAE/resolve/main/Realistic_Vision_V6.0_B1_noVAE.safetensors model_cache/model.safetensors
    
    # 方案 B (针对你的情况): 使用 Python 脚本在构建时下载 (更通用)
    # 这种方式兼容性最好，因为它利用 diffusers 自动处理文件夹结构
    - python3 -c 'import torch; from diffusers import StableDiffusionImg2ImgPipeline; pipe = StableDiffusionImg2ImgPipeline.from_pretrained("SG161222/Realistic_Vision_V6.0_B1_noVAE", torch_dtype=torch.float16); pipe.save_pretrained("model_cache")'
    
    # 4. 下载 LCM LoRA
    - python3 -c 'import torch; from diffusers import StableDiffusionImg2ImgPipeline; pipe = StableDiffusionImg2ImgPipeline.from_pretrained("model_cache", torch_dtype=torch.float16); pipe.load_lora_weights("latent-consistency/lcm-lora-sdv1-5"); pipe.save_lora_weights("model_cache/lcm_lora", adapter_name="lcm")'

predict: "predict.py:Predictor"
